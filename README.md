# 🏭 Sempio Claims Analytics Navigator

## 📋 목차
- [프로젝트 개요](#-프로젝트-개요)
- [주요 기능](#-주요-기능)
- [시스템 아키텍처](#-시스템-아키텍처)
- [설치 및 실행](#-설치-및-실행)
- [데이터 구조](#-데이터-구조)
- [사용 가이드](#-사용-가이드)
- [기술 스택](#-기술-스택)
- [함수 레퍼런스](#-함수-레퍼런스)
- [트러블슈팅](#-트러블슈팅)

---

## 🎯 프로젝트 개요

식품 제조업의 **소비자 클레임 데이터**를 분석하고 예측하는 AI 기반 통합 분석 시스템입니다.

### 핵심 가치
- 📊 **월별 클레임 추이** 시각화 (건수/ppm)
- 🤖 **Perplexity Pro API** 기반 AI 심화 해석
- 📈 **ARIMA/SARIMA** 시계열 예측 (6개월 미래)
- 🔍 **품질이슈/변경이력** 관리 및 영향 분석
- 🎨 **Gradio 인터랙티브 UI**

---

## ✨ 주요 기능

### 1️⃣ 전체 대시보드
- **월별 클레임 트렌드**: 건수/ppm 이중축 그래프
- **전년 동월 비교**: 2024 vs 2023 막대+선 그래프
- **카테고리 분석**: 2·3차분류 파이차트
- **리드타임 분포**: 제조→접수 지연일수 히스토그램
- **제조업체별 요약**: 총건수, 월평균, 최근6개월 평균

### 2️⃣ AI 통계적 분석

**KPI 자동 계산**
- 월평균/표준편차/변동계수(CV)
- 장기 추세 분류 (증가/감소/안정)
- 최근 6개월 vs 과거 6개월 수준 비교
- 이상치 탐지 (IQR 기반)
- 자기상관(lag1)
- 계절성 진폭비(amp_ratio)
- 리드타임 통계 (평균/중앙값/집중구간)

**Perplexity Pro 심화 해석**
- 민감 정보 마스킹 (M001, P001 토큰화)
- 공정·포장·보관·유통 관점 연결
- 품질이슈 일자를 리드타임 고려하여 접수월 영향 분석
- 실행 가능한 관리 포인트 3가지 제시

### 3️⃣ 예측 (시계열 모델)
- **auto_arima** 자동 파라미터 탐색
- **계절성 자동 감지** (진폭비 ≥ 0.5 → SARIMA 적용)
- **최근 12개월 + 미래 6개월** 시각화
- **모델 해석 HTML**: p/d/q/P/D/Q 각 파라미터의 한글 의미 설명

### 4️⃣ 품질이슈/변경이력 관리
- **이벤트 등록**: 날짜, 내용, 필터(제조업체, 분류, 품목군, 제품명)
- **UUID 기반 관리**: 고유 ID로 중복 방지
- **필터링된 목록**: 선택한 조건에 맞는 이벤트만 표시
- **삭제 기능**: 행 클릭 → id 선택 → 삭제

### 5️⃣ 로우 데이터
- 필터 적용된 원본 데이터 조회
- 전체 컬럼 확인 가능

---

## 🏗 시스템 아키텍처
```
┌─────────────────────────────────────────────────────────────┐
│                     Gradio Web UI                           │
│  (제품/상품, 제조업체, 분류, 품목군, 제품명, 날짜 필터)        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│                  데이터 레이어                              │
│  ┌───────────────┐  ┌──────────────┐  ┌─────────────┐      │
│  │ data2.xlsx    │  │ master_data  │  │ events.json │      │
│  │ (클레임 원본)  │  │ (유통기한)    │  │ (품질이슈)  │      │
│  └───────────────┘  └──────────────┘  └─────────────┘      │
│  ┌────────────────────────────────────────────────┐        │
│  │ data/*.xlsx (출고량: 공장명YYYYMM.xlsx)         │        │
│  └────────────────────────────────────────────────┘        │
└────────────────────────────────────────────────────────────┘
                              ↓
┌────────────────────────────────────────────────────────────┐
│                  분석 엔진                                  │
│  ┌─────────────────────┐  ┌──────────────────────┐         │
│  │ 통계 분석            │  │ 시계열 예측           │         │
│  │ - 추세/이상치        │  │ - ARIMA/SARIMA       │         │
│  │ - 리드타임           │  │ - auto_arima         │         │
│  │ - 자기상관/계절성    │  │ - 6개월 forecast     │          │
│  └─────────────────────┘  └──────────────────────┘         │
└────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  Perplexity Pro API                         │
│  (마스킹된 KPI → AI 심화 해석 → 마크다운 보고서)               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  시각화 레이어                               │
│  Plotly 차트 (이중축, 이상치 표시, 이벤트 수직선)              │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 설치 및 실행

### 1. 환경 요구사항
```
Python >= 3.8
```

### 2. 의존성 설치
```bash
pip install pandas numpy gradio requests plotly statsmodels pmdarima openpyxl
```

### 3. 디렉토리 구조
```
project/
├── claim.py               # 메인 애플리케이션
├── data/
│   ├── data2.xlsx         # 클레임 데이터
│   ├── master_data.xlsx   # 품목별 유통기한
│   ├── 이천공장202501.xlsx # 출고량 (예시)
│   └── ...
├── events.json            # 품질이슈/변경이력 (자동 생성)
└── README.md
```

### 4. 환경변수 설정 (선택)
```python
# claim.py 상단
PPLX_API_KEY = "your-perplexity-api-key"  # Perplexity Pro API 키
```

### 5. 실행
```bash
python claim.py
```

### 6. 접속
```
http://localhost:7860
```

---

## 📂 데이터 구조

### data2.xlsx (클레임 데이터)
| 컬럼명 | 설명 | 비고 |
|--------|------|------|
| 제조업체 | 공장명 | 예: 이천공장, 양포식품 |
| 제품명 | 품목명 | |
| 소비기한 | YYYY-MM-DD | |
| 접수일자 | YYYY-MM-DD | |
| 클레임유형1/2/3 | 1·2·3차분류 | 내부적으로 "1차분류" 등으로 rename |
| 품목군 | 제품 그룹 | |

### master_data.xlsx (유통기한 마스터)
| 컬럼명 | 설명 |
|--------|------|
| 품목명 | 제품명과 조인 키 |
| 유통기한 | 개월 수 (숫자) |

### data/*.xlsx (출고량)
- **파일명 규칙**: `공장명YYYYMM.xlsx`
  - 예: `이천공장202501.xlsx`
- **필수 컬럼**: `내수실제판매량B`

### events.json (품질이슈/변경이력)
```json
{
  "events": [
    {
      "id": "uuid-string",
      "date": "2024-07-01",
      "desc": "공정 변경",
      "manufacturer": "이천공장",
      "cat1_val": "전체",
      "cat2_val": "전체",
      "cat3_val": "전체",
      "group_val": ["그룹A", "그룹B"],
      "product_val": "제품A"
    }
  ]
}
```

---

## 📖 사용 가이드

### Step 1: 필터 선택
1. **제품/상품** 라디오 버튼 선택
   - 제품: 4개 공장만
   - 상품: 나머지 업체
2. **제조업체** 드롭다운
3. **연도 선택**: 자동으로 해당 연도 전체 기간 설정
4. **분류/품목군/제품명**: 멀티셀렉트 가능

### Step 2: 탭별 기능 활용

#### 📊 전체 대시보드
- 자동 로딩: 필터 변경 시 즉시 갱신
- 전년 비교 그래프 확인
- 월별 상세 표에서 동월/누적 대비 % 확인

#### 🤖 AI 통계적 분석
1. "분석 실행" 버튼 클릭
2. 좌측: 그래프(이상치 빨간 점, 이벤트 초록 선)
3. 우측: Perplexity Pro 마크다운 보고서

#### 📈 예측 (시계열 모델)
1. "예측 실행" 버튼 클릭
2. 최근 12개월 + 미래 6개월 그래프
3. 모델 해석 HTML 확인
   - 계절성 유무
   - p/d/q 파라미터 의미

#### 🔍 품질이슈/변경이력
1. 날짜/내용 입력
2. "신규 저장" 클릭
3. 목록에서 행 클릭 → id 선택
4. "선택 삭제" 버튼

#### 📁 로우 데이터
- "조회" 버튼 클릭
- 필터 적용된 원본 데이터 확인

---

## 🛠 기술 스택

### Backend
| 라이브러리 | 용도 |
|-----------|------|
| **pandas** | 데이터 처리 |
| **numpy** | 수치 연산 |
| **statsmodels** | ARIMA, SARIMAX |
| **pmdarima** | auto_arima |
| **requests** | Perplexity API 호출 |

### Frontend
| 라이브러리 | 용도 |
|-----------|------|
| **gradio** | 웹 인터페이스 |
| **plotly** | 인터랙티브 차트 |

### AI
- **Perplexity Pro API** (sonar 모델)

---

## 📚 함수 레퍼런스

### 데이터 로드
```python
load_base_df()
# 반환: DataFrame (제조일자 계산 완료)

load_output_volume()
# 반환: DataFrame [제조업체, 월, 출고량]
```

### 통계 분석
```python
_compute_core_kpis(y_for_model, x, manu_df)
# 반환: dict {
#   trend_cls, level_info, cv_val,
#   delay_stats, outlier_periods, outlier_thres,
#   auto_corr_lag1_3, seasonality_kpi
# }
```

### 예측
```python
predict(prod_type, 제조업체, 기준, ...)
# 반환: (plotly_figure, summary_html)
```

### 이벤트 관리
```python
add_event(date_str, desc, manu, ...)
# 반환: "저장되었습니다: ..." 메시지

delete_event(selected_id)
# 반환: "N건 삭제되었습니다." 메시지
```

---

## 📊 주요 메트릭 정의

| 메트릭 | 수식 | 의미 |
|--------|------|------|
| **ppm** | (클레임 건수 / 출고량) × 1,000,000 | 백만개당 불량률 |
| **변동계수(CV)** | 표준편차 / 평균 | 변동성 (0.3 이상 시 불안정) |
| **slope_std** | slope / std | 표준화된 추세 기울기 |
| **진폭비** | (max월평균 - min월평균) / 전체평균 | 계절성 강도 (0.5 이상 시 계절성 있음) |
| **리드타임** | 접수일자 - 제조일자 (일) | 제조→접수 지연 |

---

## 🔐 보안 (마스킹)

민감 정보 토큰화:
```python
# 원본
제조업체: "이천공장"
제품명: "된장 500g"

# API 전송 시
manufacturer: "M001"
제품: "P003"
```

---

## 🎓 참고 자료

- [Gradio 공식 문서](https://gradio.app)
- [Plotly Python](https://plotly.com/python/)
- [statsmodels ARIMA](https://www.statsmodels.org/stable/generated/statsmodels.tsa.arima.model.ARIMA.html)
- [pmdarima auto_arima](http://alkaline-ml.com/pmdarima/modules/generated/pmdarima.arima.auto_arima.html)
- [Perplexity API](https://docs.perplexity.ai)

